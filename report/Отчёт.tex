\documentclass[a4paper,12pt]{article}
\usepackage[left=2cm,right=1cm,top=1cm,bottom=1.5cm]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{cite}
\usepackage{indentfirst}
\usepackage{multicol}
\usepackage{cmap}
\usepackage{hyperref}
\usepackage{esint}
\usepackage{listings}
%\usepackage{minted}
\usepackage{xcolor}
%\usepackage{inconsolata}
%\renewcommand*\familydefault{\ttdefault} %% Only if the base font of the document is to be typewriter style
%\usepackage[T1]{fontenc}
\hypersetup{
	colorlinks=true,
	linkcolor=black,
	filecolor=black,  
	urlcolor=blue,
	pdftitle={Overleaf Example},
	pdfpagemode=FullScreen,
}

\sloppy

\usepackage{geometry}
\geometry{top=2cm}
\geometry{bottom=2cm}
\geometry{left=2.5cm}
\geometry{right=2.5cm}

\renewcommand{\baselinestretch}{1.5}

	\newcommand{\ds}{\displaystyle}
	\renewcommand{\phi}{\varphi}
	\newcommand{\sgn}{\, \text{sgn} \,}
	\renewcommand{\a}{\alpha}
	\renewcommand{\b}{\beta}
	\renewcommand{\l}{\lambda}
	\renewcommand{\d}{\partial}
	\renewcommand{\^}[2]{#1^{\, #2} \kern -1pt}
	\newcommand{\veco}{\kern -1pt \vec{\kern 1pt 0}}
	\newcommand{\1}{\kern 1pt}
	\newcommand{\0}{\kern -1pt}
	\renewcommand{\Phi}{\varPhi}
	

\begin{document}
	\renewcommand{\contentsname}{\Large Содержание}
	\renewcommand{\bibname}{\normalfont\Large\bfseries Список литературы}
	
	\begin{titlepage}
		\begin{center}
			\tiny{МИНИСТЕРСТВО НАУКИ И ВЫСШЕГО ОБРАЗОВАНИЯ РОССИЙСКОЙ ФЕДЕРАЦИИ\\
			ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ АВТОНОМНОЕ ОБРАЗОВАТЕЛЬНОЕ УЧРЕЖДЕНИЕ\\
			ВЫСШЕГО ОБРАЗОВАНИЯ}\\
			\normalsize{\textbf{Национальный исследовательский ядерный университет «МИФИ»}}\\*
			\hrulefill
		\end{center}
		\vspace{0.5cm}
		
		\begin{center}
			\large{\textbf{Институт}\\
			\textbf{интеллектуальных кибернетических систем}}
		\end{center}
		\vspace{0.5cm}
		
		\begin{center}
			\large{\textbf{Кафедра кибернетики (№ 22)}}
		\end{center}
		
		\vspace{0.5cm}
		
		\begin{center}
			\large{\textbf{Отчёт о работе по курсу}\\
			\textbf{«Базы данных (теоретические основы баз данных)»}}
		\end{center}
		
		\begin{center}
			\large \underline{Вариант «Онлайн кассы для сети кинотеатров»}
		\end{center}
		\vspace{1.0cm}
		
		\begin{flushright}
			\begin{tabular}{|l|c|}
				\hline
				Выполнил      & Рокин О.Д.      \\ \hline
				Группа        & Б21-215         \\ \hline
				Вариант 	  & \begin{tabular}[c]{@{}c@{}}Онлайн кассы для\\ сети кинотеатров\end{tabular} \\ \hline
				Преподаватель & Миркасымов Р.Б. \\ \hline
				Проверяющий   &                 \\ \hline
				Оценка        &                 \\ \hline
			\end{tabular}
		\end{flushright}
		
		
		\vspace{15em}
		
		\begin{center}
			\textbf{Москва 2023}
		\end{center}
	\end{titlepage}
	
	\newpage 
	\tableofcontents
	\setcounter{page}{2}
	
	\newpage
	
	\section{Формулировка задания}
	
	Спроектировать базу данных для онлайн кассы сети кинотеатров, находящейся в разных городах России и осуществляющую продажу билетов на показы кино. База данных должна содержать информацию о клиентах, сотрудниках, кино, существующих в прокате. В ней так же должны отображаться билеты, производимые транзакции и подробная информация о проходящем кино.
	
	%\newpage
	
	\section{Концептуальная модель базы данных}
	
	После проведения анализа предметной области была спроектирована следующая концептуальная модель:
	
	\begin{figure}[h]
		%\hspace{-1.75cm}
		\includegraphics[scale=0.081,page=1]{Концептуальная модель.pdf}
		\caption{Концептуальная модель базы данных}
	\end{figure}
	
	\newpage
	
	\subsection{Конкретизация предметной области}
	
	Необходимо создать систему, отражающую информацию о билетах на сеансы кино, производящую отметку об оплате конкретному клиенту. База данных должна содержать подробную информацию о кино и связанных с ней людях, должна отображать сотрудников каждого отдельного кинотеатра.
	
	%\newpage
	
	\subsection{Описание предметной области}
	
	Система ориентирована на зарегестрированных либо по почте либо по телефону пользователей.
	
	Любой пользователь может узнать все о кинотеатрах: адрес, контакт, проходящие сеансы. Клиент может узнать подробную информацию о кино, которое хочет посмотреть: его режиссера(ов), актеров, продюссеров, операторов и т.п., наличие номинаций или побед в номинациях различных кинопремий. Можно так же посмотреть информацию о каждом из людей, что работают над фильмом, допустим, узнать что-то про актера, что сыграл в данном кино. Клиент может создать заказ с любым количеством билетов, забронировать и оплатить либо сразу онлайн, либо уже в кинотеатре.
	Клиент может просмотреть историю заказов.
	
	Сотрудники кинотеатров могут производить продажу билетов, анализировать продажи.
	
	Таким образом, были выделены следующие сущности:
	
	\begin{itemize}
		\setlength\itemsep{0.05cm}
		
		\item Фильмы
		
		\item Изображения
		
		\item Жанры
		
		\item Члены съёмочной группы
		
		\item Номинации
		
		\item Награды
		
		\item Сеансы
		
		\item Билеты
		
		\item Заказы
		
		\item Оплата
		
		\item Пользователи
		
		\item Залы
		
		\item Сиденья
		
		\item Кинотеатры
		
		\item Сотрудники
		
		\item Должности в кинотеатре
	\end{itemize}
	
	%\newpage
	
	\subsection{Описание атрибутов}
	
	В процессе анализа были выделены следующие атрибуты, название и описание которых приведены в таблице ниже.
	
	\begin{center}
		\begin{tabular}{|p{4cm}|p{4cm}|p{7cm}|}
			\hline
			\textbf{Имя сущности}	& \textbf{Имя атрибута} 	& \textbf{Расшифровка}	\\ \hline
			Фильмы	& Название	& Название фильма (необязательно уникальное)	\\ \hline
			Фильмы	& Дата выхода	& Дата выхода фильма	\\ \hline
			Фильмы	& Длительность	& Длительность фильма	\\ \hline
			Фильмы	& Возрастное ограничение	& Возрастное ограничение фильма (PG-13, R и т.п.)	\\ \hline
			Фильмы	& Описание	& Описание к фильму	\\ \hline
			Фильмы	& Рейтинг	& Рейтинг/оценка фильма	\\ \hline
			Фильмы	& Ссылка на Кинопоиск	& Ссылка на страницу фильма на сайте kinopoisk.ru	\\ \hline
			Изображения	& Ссылка	& Ссылка на изображение к фильму	\\ \hline
			Изображения	& Постер?	& Отвечает, является ли изображение постером к фильму, или просто кадром/скриншотом	\\ \hline
			Жанры	& Название	& Название жанра фильма	\\ \hline
			Члены съёмочной группы	& Имя	& Полное имя члена съёмочной группы (необязательно уникальное)	\\ \hline
			Члены съёмочной группы	& Дата рождения	& Дата рождения члена съёмочной группы	\\ \hline
		\end{tabular}
	\end{center}

	\begin{center}
		\begin{tabular}{|p{4cm}|p{4cm}|p{7cm}|}
			\hline
			Члены съёмочной группы	& Место рождения	& Место рождения члена съёмочной группы	\\ \hline
			Члены съёмочной группы	& Рост	& Рост члена съёмочной группы (важно для актёров)	\\ \hline
			Номинации	& Название	& Название номинации (за лучшую мужскую роль, за лучшую роль второго плана и т.п.)	\\ \hline
			Номинации	& Статус	& Отвечает, оказался ли номинант победителем	\\ \hline
			Номинации	& Год	& Год выдвижения номинации	\\ \hline
			Награды	& Название	& Название награды (Оскар, Золотой глобус и т.п.)	\\ \hline
			Сеансы	& Время начала	& Время начала сеанса	\\ \hline
			Сеансы	& Время окончания	& Время окончания сеанса	\\ \hline
			Билеты	& Цена	& Цена за билет (может различаться даже в пределах одного зала)	\\ \hline
			Заказы	& Забронирован?	& Отвечает, забронирован ли заказ, или его только начали оформлять	\\ \hline
			Заказы	& Полная стоимость	& Полная стоимость заказа (вычисляется как сумма цен за билеты)	\\ \hline
			Оплата	& Способ оплаты	& Способ оплаты (оплата наличными на месте, оплата банковской картой онлайн и т.п.)	\\ \hline
			Оплата	& Время оплаты	& Время, когда была произведена оплата	\\ \hline
			Пользователи	& Имя	& Полное имя пользователя (необязательно уникальное)	\\ \hline
			Пользователи	& Дата рождения	& Дата рождения пользователя	\\ \hline
			Пользователи	& Логин	& Логин пользователя	\\ \hline
			Пользователи	& Пароль	& Пароль пользователя	\\ \hline
			Пользователи	& Телефон	& Номер телефона пользователя	\\ \hline
			Пользователи	& Почта	& Электронная почта пользователя	\\ \hline
			

		\end{tabular}
	\end{center}

	\begin{center}
		\begin{tabular}{|p{4cm}|p{4cm}|p{7cm}|}
			\hline
			Пользователи	& Аватар	& Ссылка на изображение, являющееся аватаром пользователя	\\ \hline
			Залы	& Название/Номер	& Название/Номер зала	\\ \hline
			Залы	& Тип	& Тип зала (стандартный, VIP и т.п.)	\\ \hline
			Сиденья	& Ряд	& Ряд сиденья	\\ \hline
			Сиденья	& Место	& Место сиденья	\\ \hline
			Кинотеатры	& Название	& Название кинотеатра	\\ \hline
			Кинотеатры	& Адрес	& Адрес кинотеатра	\\ \hline
			Кинотеатры	& Телефон	& Официальный номер телефона кинотеатра	\\ \hline
			Сотрудники	& Имя	& Полное имя сотрудника (необязательно уникальное)	\\ \hline
			Сотрудники	& Дата рождения	& Дата рождения сотрудника	\\ \hline
			Сотрудники	& Логин	& Логин сотрудника	\\ \hline
			Сотрудники	& Пароль	& Пароль сотрудника	\\ \hline
			Сотрудники	& Телефон	& Номер телефона сотрудника	\\ \hline
			Сотрудники	& Почта	& Электронная почта сотрудника	\\ \hline
			Должности в кинотеатре	& Название	& Название должности сотрудника в кинотеатре	\\ \hline
		\end{tabular}
	\end{center}
	
	\newpage
	
	\section{Логическое проектирование}
	
	Следующим шагом на основе КМПО была разработана логическая модель базы данных, представленная ниже:
	
	\begin{figure}[h]
		\hspace{-1.75cm}
		\includegraphics[scale=0.19,page=1]{Логическая модель.png}
		\caption{Логическая модель базы данных}
	\end{figure}

	Все связи типа «Многие ко многим» были реализованы через отдельные таблицы.
	
	Все таблицы базы данных находятся в 3НФ, т.к. все атрибуты являются простыми, отсутствуют функциональные зависимости между неключевыми атрибутами и первичными ключами, а также нет транзитивных зависимостей.
	
	\newpage
	
	\section{Физическое проектирование}
	
	В качестве СУБД для реализации разработанной базы данных была выбрана PostgreSQL. В связи с проведённым анализом предметной области и была проработана следующая физическая схема базы данных. Она представлена на следующем рисунке:
	
	\begin{figure}[h]
		\hspace{-1.75cm}
		\includegraphics[scale=0.5,page=1]{Графическое представление.png}
		\caption{Графическое представление базы данных}
	\end{figure}
	
	\newpage
	
	\subsection{Создание таблиц}	
	
	Ниже приведены скриптовый код на языке SQL (диалект PostgreSQL) для создания таблиц, описанных выше.
	
	\begin{itemize}
	
	\lstdefinestyle{vscode-dark}{
		backgroundcolor=\color{black},
		basicstyle=\color{white}\ttfamily\fontsize{8}{11}\selectfont,
		breakatwhitespace=false,
		breaklines=true,
		captionpos=b,
		commentstyle=\color{green!40!black},
		keywordstyle=\color{cyan},
		numbersep=5pt,
		numberstyle=\tiny\color{gray},
		showstringspaces=false,
		stringstyle=\color{orange},
		tabsize=4,
		extendedchars=true,
		upquote=true,
		literate=
			{а}{{\selectfont\char224}}1
			{б}{{\selectfont\char225}}1
			{в}{{\selectfont\char226}}1
			{г}{{\selectfont\char227}}1
			{д}{{\selectfont\char228}}1
			{е}{{\selectfont\char229}}1
			{ё}{{\"e}}1
			{ж}{{\selectfont\char230}}1
			{з}{{\selectfont\char231}}1
			{и}{{\selectfont\char232}}1
			{й}{{\selectfont\char233}}1
			{к}{{\selectfont\char234}}1
			{л}{{\selectfont\char235}}1
			{м}{{\selectfont\char236}}1
			{н}{{\selectfont\char237}}1
			{о}{{\selectfont\char238}}1
			{п}{{\selectfont\char239}}1
			{р}{{\selectfont\char240}}1
			{с}{{\selectfont\char241}}1
			{т}{{\selectfont\char242}}1
			{у}{{\selectfont\char243}}1
			{ф}{{\selectfont\char244}}1
			{х}{{\selectfont\char245}}1
			{ц}{{\selectfont\char246}}1
			{ч}{{\selectfont\char247}}1
			{ш}{{\selectfont\char248}}1
			{щ}{{\selectfont\char249}}1
			{ъ}{{\selectfont\char250}}1
			{ы}{{\selectfont\char251}}1
			{ь}{{\selectfont\char252}}1
			{э}{{\selectfont\char253}}1
			{ю}{{\selectfont\char254}}1
			{я}{{\selectfont\char255}}1
			{А}{{\selectfont\char192}}1
			{Б}{{\selectfont\char193}}1
			{В}{{\selectfont\char194}}1
			{Г}{{\selectfont\char195}}1
			{Д}{{\selectfont\char196}}1
			{Е}{{\selectfont\char197}}1
			{Ё}{{\"E}}1
			{Ж}{{\selectfont\char198}}1
			{З}{{\selectfont\char199}}1
			{И}{{\selectfont\char200}}1
			{Й}{{\selectfont\char201}}1
			{К}{{\selectfont\char202}}1
			{Л}{{\selectfont\char203}}1
			{М}{{\selectfont\char204}}1
			{Н}{{\selectfont\char205}}1
			{О}{{\selectfont\char206}}1
			{П}{{\selectfont\char207}}1
			{Р}{{\selectfont\char208}}1
			{С}{{\selectfont\char209}}1
			{Т}{{\selectfont\char210}}1
			{У}{{\selectfont\char211}}1
			{Ф}{{\selectfont\char212}}1
			{Х}{{\selectfont\char213}}1
			{Ц}{{\selectfont\char214}}1
			{Ч}{{\selectfont\char215}}1
			{Ш}{{\selectfont\char216}}1
			{Щ}{{\selectfont\char217}}1
			{Ъ}{{\selectfont\char218}}1
			{Ы}{{\selectfont\char219}}1
			{Ь}{{\selectfont\char220}}1
			{Э}{{\selectfont\char221}}1
			{Ю}{{\selectfont\char222}}1
			{Я}{{\selectfont\char223}}1
	}
	
	\item Код для создания таблицы Movies
		
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Movies" (
			"id" serial NOT NULL,
			"name" varchar(255) NOT NULL,
			"release_date" DATE,
			"duration" TIME NOT NULL,
			"mpaa" varchar(10),
			"rating" float4,
			"kp_id" varchar(255),
			"description" TEXT,
			CONSTRAINT "Movies_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}


	\item Код для создания таблицы Genres

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Genres" (
			"id" serial NOT NULL,
			"name" varchar(50) UNIQUE NOT NULL,
		CONSTRAINT "Genres_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}

	\item Код для создания таблицы Movies\_genres

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Movies_genres" (
			"movie_id" integer NOT NULL,
			"genres_id" integer NOT NULL,
			CONSTRAINT "Movies_genres_pk" PRIMARY KEY ("movie_id", "genres_id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Movies_genres" ADD CONSTRAINT "Movies_genres_fk0" FOREIGN KEY ("movie_id") REFERENCES "public.Movies"("id");
		ALTER TABLE "public.Movies_genres" ADD CONSTRAINT "Movies_genres_fk1" FOREIGN KEY ("genres_id") REFERENCES "public.Genres"("id");
	\end{lstlisting}

	\item Код для создания таблицы Pictures\_movie

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Pictures_movie" (
			"id" serial NOT NULL,
			"movie_id" integer NOT NULL,
			"isMain" BOOLEAN NOT NULL DEFAULT 'false',
			"ref" varchar(255) NOT NULL UNIQUE,
			CONSTRAINT "Pictures_movie_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Pictures_movie" ADD CONSTRAINT "Pictures_movie_fk0" FOREIGN KEY ("movie_id") REFERENCES "public.Movies"("id");
	\end{lstlisting}
	%$\\$
	
	\item Код для создания таблицы Film\_crew\_members
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Film_crew_members" (
			"id" serial NOT NULL,
			"name" varchar(255) NOT NULL,
			"birthday" DATE,
			"birthplace" varchar(255),
			"height" integer,
			CONSTRAINT "Film_crew_members_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}

	\item Код для создания таблицы Films\_positions

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Films_positions" (
			"id" serial NOT NULL,
			"movie_id" integer NOT NULL,
			"member_id" integer NOT NULL,
			"name" varchar(255) NOT NULL,
			CONSTRAINT "Films_crews_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Films_positions" ADD CONSTRAINT "Films_positions_fk0" FOREIGN KEY ("movie_id") REFERENCES "public.Movies"("id");
		ALTER TABLE "public.Films_positions" ADD CONSTRAINT "Films_positions_fk1" FOREIGN KEY ("member_id") REFERENCES "public.Film_crew_members"("id");
	\end{lstlisting}
	\newpage
	
	\item Код для создания таблицы Nominees
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Nominees" (
			"id" serial NOT NULL,
			"movie_id" integer,
			"film_crew_members_id" integer,
			CONSTRAINT "Nominees_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Nominees" ADD CONSTRAINT "Nominees_fk0" FOREIGN KEY ("movie_id") REFERENCES "public.Movies"("id");
		ALTER TABLE "public.Nominees" ADD CONSTRAINT "Nominees_fk1" FOREIGN KEY ("film_crew_members_id") REFERENCES "public.Film_crew_members"("id");
		ALTER TABLE "public.Nominees" ADD CONSTRAINT "Nominees_unique" UNIQUE("movie_id","film_crew_members_id");
	\end{lstlisting}
	
	\item Код для создания таблицы Primes
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Primes" (
			"id" serial NOT NULL,
			"name" varchar(50) NOT NULL UNIQUE,
			CONSTRAINT "Primes_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}

	\item Код для создания таблицы Prime\_nominations

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Prime_nominations" (
			"id" serial NOT NULL,
			"nominee_id" integer NOT NULL,
			"prime_id" integer NOT NULL,
			"nomination" varchar(255) NOT NULL,
			"year" smallint NOT NULL,
			"isWon" BOOLEAN NOT NULL DEFAULT 'false',
			CONSTRAINT "Prime_nominations_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Prime_nominations" ADD CONSTRAINT "Prime_nominations_fk0" FOREIGN KEY ("nominee_id") REFERENCES "public.Nominees"("id");
		ALTER TABLE "public.Prime_nominations" ADD CONSTRAINT "Prime_nominations_fk1" FOREIGN KEY ("prime_id") REFERENCES "public.Primes"("id");
	\end{lstlisting}
	
	\item Код для создания таблицы Cinemas
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Cinemas" (
			"id" serial NOT NULL,
			"name" varchar(50) NOT NULL UNIQUE,
			"location" varchar(255) UNIQUE,
			"phone" varchar(20),
			CONSTRAINT "Cinemas_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}
	
	\item Код для создания таблицы Halls
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Halls" (
			"id" serial NOT NULL,
			"name" varchar(255) NOT NULL,
			"type" varchar(255),
			"cinema_id" integer NOT NULL,
			CONSTRAINT "Halls_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Halls" ADD CONSTRAINT "Halls_fk0" FOREIGN KEY ("cinema_id") REFERENCES "public.Cinemas"("id");
	\end{lstlisting}

	\item Код для создания таблицы Sessions

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Sessions" (
			"id" serial NOT NULL,
			"movie_id" serial NOT NULL ,
			"time_start" TIMESTAMP NOT NULL,
			"time_end" TIMESTAMP NOT NULL,
			"hall_id" integer NOT NULL,
			CONSTRAINT "Sessions_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Sessions" ADD CONSTRAINT "Sessions_fk0" FOREIGN KEY ("movie_id") REFERENCES "public.Movies"("id");
		ALTER TABLE "public.Sessions" ADD CONSTRAINT "Sessions_fk1" FOREIGN KEY ("hall_id") REFERENCES "public.Halls"("id");
		ALTER TABLE "public.Sessions" ADD CONSTRAINT "Sessions_unique" UNIQUE("hall_id", "time_start");
	\end{lstlisting}
	
	\item Код для создания таблицы Seats
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Seats" (
			"id" serial NOT NULL,
			"row" smallint NOT NULL,
			"place" smallint NOT NULL,
			"hall_id" integer NOT NULL,
			CONSTRAINT "Seats_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Seats" ADD CONSTRAINT "Seats_fk0" FOREIGN KEY ("hall_id") REFERENCES "public.Halls"("id");
		ALTER TABLE "public.Seats" ADD CONSTRAINT "Seats_unique" UNIQUE("row", "place", "hall_id");
	\end{lstlisting}

	\item Код для создания таблицы Customers

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Customers" (
			"id" serial NOT NULL,
			"name" varchar(255),
			"birthday" DATE,
			"login" varchar(20) UNIQUE,
			"avatar_ref" varchar(255),
			"phone" varchar(20) UNIQUE,
			"mail" varchar(255) UNIQUE,
			"password" varchar(255) NOT NULL,
			CONSTRAINT "Customers_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}

	\item Код для создания таблицы Orders

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Orders" (
			"id" serial NOT NULL,
			"customer_id" integer NOT NULL,
			"isBooked" BOOLEAN DEFAULT(false),
			"total_price" integer NOT NULL DEFAULT 0,
			CONSTRAINT "Orders_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Orders" ADD CONSTRAINT "Orders_fk0" FOREIGN KEY ("customer_id") REFERENCES "public.Customers"("id");
	\end{lstlisting}
	
	\item Код для создания таблицы Payment

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Payment" (
			"id" serial NOT NULL,
			"type" varchar(50) NOT NULL,
			"order_id" integer NOT NULL UNIQUE,
			"payment_time" TIMESTAMP,
			CONSTRAINT "Payment_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Payment"  ADD CONSTRAINT "Payment_fk0" FOREIGN KEY ("order_id") REFERENCES "public.Orders"("id");
	\end{lstlisting}

	\item Код для создания таблицы Tickets

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Tickets" (
			"id" serial NOT NULL,
			"seat_id" integer NOT NULL,
			"session_id" integer NOT NULL,
			"price" integer NOT NULL,
			"order_id" integer NOT NULL,
			CONSTRAINT "Tickets_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Tickets" ADD CONSTRAINT "Tickets_fk0" FOREIGN KEY ("seat_id") REFERENCES "public.Seats"("id");
		ALTER TABLE "public.Tickets" ADD CONSTRAINT "Tickets_fk1" FOREIGN KEY ("session_id") REFERENCES "public.Sessions"("id");
		ALTER TABLE "public.Tickets" ADD CONSTRAINT "Tickets_fk2" FOREIGN KEY ("order_id") REFERENCES "public.Orders"("id");
		ALTER TABLE "public.Tickets" ADD CONSTRAINT "Tickets_unique" UNIQUE("seat_id", "session_id");
	\end{lstlisting}
	\newpage

	\item Код для создания таблицы Cinemas\_positions

	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Cinemas_positions" (
			"id" serial NOT NULL,
			"position" varchar(255) NOT NULL UNIQUE,
			CONSTRAINT "Cinemas_positions_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
	\end{lstlisting}
	
	\item Код для создания таблицы Staff
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		CREATE TABLE IF NOT EXISTS "public.Staff" (
			"id" serial NOT NULL,
			"cinema_id" integer NOT NULL,
			"position_id" integer NOT NULL,
			"login" varchar(20) NOT NULL UNIQUE,
			"password" varchar(255) NOT NULL,
			"birthday" DATE NOT NULL,
			"phone" varchar(20) NOT NULL UNIQUE,
			"email" varchar(255) NOT NULL UNIQUE,
			"name" varchar(255) NOT NULL,
		CONSTRAINT "Staff_pk" PRIMARY KEY ("id")
		) WITH (
			OIDS=FALSE
		);
		
		ALTER TABLE "public.Staff" ADD CONSTRAINT "Staff_fk0" FOREIGN KEY ("cinema_id") REFERENCES "public.Cinemas"("id");
		ALTER TABLE "public.Staff" ADD CONSTRAINT "Staff_fk1" FOREIGN KEY ("position_id") REFERENCES "public.Cinemas_positions"("id");
	\end{lstlisting}

	\end{itemize}
		
		
	\newpage
	
	\subsection{Заполнение базы данных}
	
	%\newpage
	
	\subsubsection{Подготовка данных}
	
	В сети Интернет найдены такие данные как существующие жанры фильмов, существующие награды и номинации к фильмам. Такие данные как сведения о фильмах (название, дата выхода, длительность, описание), сведения об актёрах (имя, дата рождения, место рождения, рост), сведения о пользователях и сотрудниках (имя, дата рождения, логин, пароль, телефон, почта, ссылка на аватар) были сгенерированы Pyhton библиотекой Faker. Для предварительной оценки сгенерированных данных они были вносились в Excel-таблицы, которые после импортировались в Python с использованием библиотеки Pandas и использовались в автоматизированном написании нужных запросов для заполнения таблиц.
	
	\begin{itemize}
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Movies
	
	\includegraphics[scale=0.7,page=1]{movies_random.pdf}
	

	\item Фрагмент сгенерированной Excel-таблицы для заполнения Movies\_genres
	
	\includegraphics[scale=0.7,page=1]{movies_genres_random.pdf}
	

	\item Фрагмент сгенерированной Excel-таблицы для заполнения Pictures\_movie
	
	\includegraphics[scale=0.7,page=1]{movie_pictures_random.pdf}
	

	\item Фрагмент сгенерированной Excel-таблицы для заполнения Film\_crew\_members
	
	
	\includegraphics[scale=0.7,page=1]{members_random.pdf}
	

	\item Фрагмент сгенерированной Excel-таблицы для заполнения Films\_positions
	
	\includegraphics[scale=0.7,page=1]{members_movies_random.pdf}
	$\\$
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Prime\_nominations
	
	\includegraphics[scale=0.7,page=1]{prime_nominations_random.pdf}
	

	\item Фрагмент сгенерированной Excel-таблицы для заполнения Cinemas
	
	\includegraphics[scale=0.7,page=1]{cinemas_random.pdf}
	

	\item Фрагмент сгенерированной Excel-таблицы для заполнения Halls
	
	\includegraphics[scale=0.7,page=1]{halls_random.pdf}
	$\\$
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Sessions
	
	\includegraphics[scale=0.7,page=1]{sessions_random.pdf}
	
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Customers
	
	\includegraphics[scale=0.7,page=1]{customers_random.pdf}
	
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Payment
	
	\includegraphics[scale=0.7,page=1]{payment_random.pdf}
	$\\$
	
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Tickets
	
	\includegraphics[scale=0.7,page=1]{tickets_random.pdf}
	
	
	\item Фрагмент сгенерированной Excel-таблицы для заполнения Staff
	
	\includegraphics[scale=0.7,page=1]{staff_random.pdf}
	
	\end{itemize}
	
	\newpage
	
	\subsubsection{Программа заполнения базы данных}
	
	Ниже приведён пример Python-кода, который принимает данные из Excel-таблицы и генерирует SQL-запрос на заполнение данными таблицы Tickets.
	
	\begin{figure}[h]
		\hspace{-0.5cm}\includegraphics[scale=0.6,page=1]{sql_tickets_insert.pdf}
	\end{figure}

	Все генерируемые подобным образом SQL-запросы направлены на то, чтобы искать id нужных таблиц и заполнять нужные данные на основе данных из Excel-таблиц. Причём нужные id в таком запросе ищутся ровно один раз даже в случае, если в Excel-таблице на один и тот же id ссылаются несколько раз.
	
	\newpage
	
	\subsubsection{Результаты заполнения}
	
	\begin{itemize}
		
	\item Фрагмент таблицы Movies

	\includegraphics[scale=0.55,page=1]{Movies.png}
	$\\$
	
	
	\item Таблица Genres
	
	\includegraphics[scale=0.29,page=1]{Genres.png}
	$\\$
	
	
	\item Фрагмент таблицы Movies\_genres
	
	\includegraphics[scale=0.29,page=1]{Movies_genres.png}
	
	\newpage
	
	
	\item Таблица Pictures\_movie
	
	\includegraphics[scale=0.3,page=1]{Pictures_movie.png}
	$\\$
	
	
	\item Фрагмент таблицы Film\_crew\_members
	
	\includegraphics[scale=0.3,page=1]{Film_crew_members.png}
	$\\$
	
	
	\item Фрагмент таблицы Films\_positions
	
	\includegraphics[scale=0.3,page=1]{Films_positions.png}
	
	\newpage
	
	\item Фрагмент таблицы Nominees
	
	\includegraphics[scale=0.3,page=1]{Nominees.png}
	$\\$
	
	
	\item Таблица Primes
	
	\includegraphics[scale=0.4,page=1]{Primes.png}
	$\\$
	
	
	\item Фрагмент таблицы Prime\_nominations
	
	\includegraphics[scale=0.3,page=1]{Prime_nominations.png}

	
	
	\item Фрагмент таблицы Cinemas
	
	\includegraphics[scale=0.3,page=1]{Cinemas.png}
	$\\$
	
	
	\item Фрагмент таблицы Halls
	
	\includegraphics[scale=0.3,page=1]{Halls.png}
	$\\$
	
	
	\item Фрагмент таблицы Sessions
	
	\includegraphics[scale=0.3,page=1]{Sessions.png}
	$\\$

	
	\item Фрагмент таблицы Seats
	
	\includegraphics[scale=0.32,page=1]{Seats.png}
	$\\$
	
	
	\item Фрагмент таблицы Customers
	
	\includegraphics[scale=0.24,page=1]{Customers.png}
	$\\$
	
	
	\item Фрагмент таблицы Orders
	
	\includegraphics[scale=0.32,page=1]{Orders.png}
	$\\$
	
	
	\item Фрагмент таблицы Payment
	
	\includegraphics[scale=0.3,page=1]{Payment.png}
	$\\$
	
	
	\item Фрагмент таблицы Tickets
	
	\includegraphics[scale=0.3,page=1]{Tickets.png}
	$\\$
	
	
	\item Таблица Cinemas\_positions
	
	\includegraphics[scale=0.3,page=1]{Cinemas_positions.png}
	$\\$
	
	
	\item Фрагмент таблицы Staff
	
	\includegraphics[scale=0.24,page=1]{Staff.png}
	
	
		
	\end{itemize}
	
	\newpage
	
	\section{Выполнение запросов}
	
	В этом разделе приведены различные запросы к реализованной базе данных — их краткие описания, непосредственно запрос на SQL языке и результат выполнения.
	
	\begin{enumerate}
	\item Вывести фильмы, на которые есть билеты стоимостью не выше 450 (выводится минимальная цена)
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT m.name, MIN(t.price)
		FROM "public.Tickets" t
		JOIN "public.Sessions" s on t.session_id = s.id
		JOIN "public.Movies" m on s.movie_id = m.id
		WHERE t.price <= 450
		GROUP BY m.name;
	\end{lstlisting}

	\includegraphics[scale=0.6,page=1]{query_1.png}
	$\\$
	
	
	\item Вывести количество фильмов по жанрам
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT g.name, COUNT(m.id) AS movies_count
		FROM "public.Movies" m
		JOIN "public.Movies_genres" mg ON m.id = mg.movie_id
		JOIN "public.Genres" g ON mg.genres_id = g.id
		GROUP BY g.name
		ORDER BY movies_count DESC;
	\end{lstlisting}

	\includegraphics[scale=0.6,page=1]{query_2.png}
	$\\$
	
	
	\item Вывести фильмы в порядке убывания количества купленных билетов на определённый день
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT m.id, m.name, COUNT(t.id) AS tickets_count
		FROM "public.Movies" m
		JOIN "public.Sessions" s ON m.id = s.movie_id
		JOIN "public.Tickets" t ON s.id = t.session_id
		JOIN "public.Orders" o ON o.id = t.order_id
		JOIN "public.Payment" p ON o.id = p.order_id
		WHERE s.time_start::date = '2023-11-05'
			AND p.payment_time IS NOT NULL
		GROUP BY m.id
		ORDER BY tickets_count DESC;
	\end{lstlisting}
	
	\includegraphics[scale=0.6,page=1]{query_3.png}
	$\\$
	
	
	\item Вывести округлённую среднюю заплаченную пользователями сумму за сеанс
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT ROUND(AVG(o.total_price))
		FROM "public.Customers" c
		JOIN "public.Orders" o ON o.customer_id = c.id
		JOIN "public.Payment" p ON p.order_id = o.id
		WHERE p.payment_time IS NOT NULL
	\end{lstlisting}
	
	\includegraphics[scale=0.8,page=1]{query_4.png}
	$\\$
	
	
	\item Вывести фильмы в заданном кинотеатре, где снимался оскароносный актёр
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT m.id, m.name, fcm.name
		FROM "public.Sessions" s
		JOIN "public.Movies" m ON m.id = s.movie_id
		JOIN "public.Halls" h ON s.hall_id = h.id
		JOIN "public.Cinemas" c ON h.cinema_id = c.id
		JOIN "public.Films_positions" fp On m.id = fp.movie_id
		JOIN "public.Film_crew_members" fcm ON fp.member_id = fcm.id
		JOIN "public.Nominees" n ON fcm.id = n.film_crew_members_id
		JOIN "public.Prime_nominations" pn ON n.id = pn.nominee_id
		JOIN "public.Primes" p ON pn.prime_id = p.id
		WHERE c.name = 'Пятый'
			AND fp.name = 'Актер'
			AND p.name = 'Оскар'
			AND pn."isWon" = True;
	\end{lstlisting}
	
	\includegraphics[scale=0.8,page=1]{query_5.png}
	$\\$
	
	
	\item Вывести людей, оплативших билеты не ранее, чем за час до начала сеанса
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT DISTINCT c.name, p.payment_time, s.time_start
		FROM "public.Customers" c
		JOIN "public.Orders" o ON c.id = o.customer_id
		JOIN "public.Payment" p ON o.id = p.order_id
		JOIN "public.Tickets" t ON o.id = t.order_id
		JOIN "public.Sessions" s ON s.id = t.session_id
		WHERE p.payment_time >= s.time_start - INTERVAL '1 hour';
	\end{lstlisting}
	
	\includegraphics[scale=0.6,page=1]{query_6.png}
	$\\$
	
	
	\item Вывести людей, суммарно заплативших за заказы 3000 и больше
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT c.name, SUM(o.total_price) AS total_paid
		FROM "public.Customers" c
		JOIN "public.Orders" o ON c.id = o.customer_id
		JOIN "public.Payment" p ON o.id = p.order_id
		WHERE p.payment_time IS NOT NULL
		GROUP BY c.name
		HAVING SUM(o.total_price) >= 3000
		ORDER BY total_paid DESC;
	\end{lstlisting}
	
	\includegraphics[scale=0.6,page=1]{query_7.png}
	$\\$
	
	
	\item Всем пользователям, которые забронировали, но не оплатили места, поставить на аватары клоунов
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		UPDATE "public.Customers"
		SET avatar_ref = 'https://icons.iconarchive.com/icons/google/noto-emoji-smileys/256/10094-clown-face-icon.png'
		FROM "public.Orders" o
		JOIN "public.Payment" p ON o.id = p.order_id
		WHERE "public.Customers".id = o.customer_id
			AND o."isBooked" = True
			AND p.payment_time IS NULL;
	\end{lstlisting}
	\newpage
	
	Было (выведены люди, забронировавшие, но не оплатившие места):
	
	\includegraphics[scale=0.6,page=1]{query_8_1.png}
	
	Стало (выведены люди, забронировавшие, но не оплатившие места):
	
	\includegraphics[scale=0.6,page=1]{query_8_2.png}
	$\\$
	
	
	\item Вывести самый кассовый фильм с возрастным рейтингом R
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT m.id, m.name, SUM(o.total_price) AS total_pay
		FROM "public.Movies" m
		JOIN "public.Sessions" s ON m.id = s.movie_id
		JOIN "public.Tickets" t ON s.id = t.session_id
		JOIN "public.Orders" o ON o.id = t.order_id
		JOIN "public.Payment" p ON o.id = p.order_id
		WHERE p.payment_time IS NOT NULL
			AND m.mpaa = 'R'
		GROUP BY m.id
		ORDER BY total_pay DESC
		LIMIT 1;
	\end{lstlisting}

	\includegraphics[scale=0.8,page=1]{query_9.png}
	%$\\$
	
	
	\item Вывести самый прибыльный за всё время кинотеатр
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT c.name, SUM(o.total_price) AS total_pay
		FROM "public.Cinemas" c
		JOIN "public.Halls" h ON h.cinema_id = c.id 
		JOIN "public.Sessions" s ON s.hall_id = h.id
		JOIN "public.Tickets" t ON t.session_id = s.id
		JOIN "public.Orders" o ON o.id = t.order_id
		JOIN "public.Payment" p ON p.order_id = o.id
		WHERE p.payment_time IS NOT NULL
		GROUP BY c.name
		ORDER BY total_pay DESC
		LIMIT 1;
	\end{lstlisting}
	
	\includegraphics[scale=0.8,page=1]{query_10.png}
	$\\$
	
	
	\item Вывести фильмы вместе со средним возрастом их аудитории
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		SELECT m.id, m.name, m.release_date, ROUND(AVG(DATE_PART('YEAR', AGE(c.birthday)))::numeric) AS average_age
		FROM "public.Movies" m
		JOIN "public.Sessions" s ON s.movie_id = m.id
		JOIN "public.Tickets" t ON t.session_id = s.id
		JOIN "public.Orders" o ON o.id = t.order_id
		JOIN "public.Payment" p ON p.order_id = o.id
		JOIN "public.Customers" c ON c.id = o.customer_id
		WHERE p.payment_time IS NOT NULL
		GROUP BY m.id
		ORDER BY m.release_date
	\end{lstlisting}
	
	\includegraphics[scale=0.6,page=1]{query_11.png}
	$\\$
	
	
	\item Вывести процент оплат наличными за месяц
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		WITH paid_cash AS (
			SELECT COUNT(p.id)
			FROM "public.Payment" p
			WHERE EXTRACT(YEAR FROM p.payment_time) = EXTRACT(YEAR FROM CURRENT_DATE)
			AND EXTRACT(MONTH FROM p.payment_time) = EXTRACT(MONTH FROM CURRENT_DATE)
			AND p.type = 'Оплата наличными на месте'
		),
		paid_total AS (
			SELECT COUNT(p.id)
			FROM "public.Payment" p
			WHERE EXTRACT(YEAR FROM p.payment_time) = EXTRACT(YEAR FROM CURRENT_DATE)
			AND EXTRACT(MONTH FROM p.payment_time) = EXTRACT(MONTH FROM CURRENT_DATE)
		)
		
		SELECT ROUND(100 * paid_cash.count / paid_total.count) AS cash_percentage
		FROM paid_cash, paid_total
	\end{lstlisting}
	
	\includegraphics[scale=0.8,page=1]{query_12.png}
	$\\$
	
	
	\item Повысить на 0.1 рейтинг пяти самых прибыльных фильмов (если их рейтинг меньше 10)
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		WITH top_movies AS (
			SELECT m.id AS movie_id
			FROM "public.Movies" m
			JOIN "public.Sessions" s ON m.id = s.movie_id
			JOIN "public.Tickets" t ON s.id = t.session_id
			JOIN "public.Orders" o ON o.id = t.order_id
			JOIN "public.Payment" p ON o.id = p.order_id
			WHERE p.payment_time IS NOT NULL
			GROUP BY m.id
			ORDER BY SUM(o.total_price) DESC
			LIMIT 5
		)
		
		UPDATE "public.Movies"
		SET rating = LEAST(rating + 0.1, 10)
		FROM top_movies
		WHERE id = top_movies.movie_id;
	\end{lstlisting}
	
	Было (выведены фильмы с рейтингами в порядке убывания кассовых сборов):
	
	\includegraphics[scale=0.6,page=1]{query_13_1.png}
	
	Стало (выведены фильмы с рейтингами в порядке убывания кассовых сборов):
	
	\includegraphics[scale=0.6,page=1]{query_13_2.png}
	$\\$
	
	
	\item Вывести число свободных сидений к сеансам за определённое число в порядке их убывания
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		WITH seats_total AS (
			SELECT h.id AS hall_id, c.name AS cinema_name, COUNT((st.row,st.place)) AS count
			FROM "public.Seats" st
			JOIN "public.Halls" h ON st.hall_id = h.id
			JOIN "public.Cinemas" c ON h.cinema_id = c.id
			GROUP BY h.id, c.name
		),
		seats_taken AS (
			SELECT h.id AS hall_id, m.name AS movie_name, s.time_start::time  AS time_start, COUNT(t.id) AS count
			FROM "public.Sessions" s
			LEFT JOIN "public.Tickets" t ON t.session_id = s.id
			JOIN "public.Movies" m ON m.id = s.movie_id
			JOIN "public.Halls" h ON s.hall_id = h.id
			JOIN "public.Cinemas" c ON h.cinema_id = c.id
			WHERE s.time_start::date = '2023-11-05'
			GROUP BY h.id, m.name, s.time_start
		)
		
		SELECT seats_total.cinema_name, seats_taken.movie_name, seats_taken.time_start, seats_total.count as total, seats_total.count - seats_taken.count AS free
		FROM seats_total
		JOIN seats_taken ON seats_total.hall_id = seats_taken.hall_id
		ORDER BY free;
	\end{lstlisting}
	
	\includegraphics[scale=0.6,page=1]{query_14.png}
	$\\$
	
	\item Данная задача сформулирована преподавателем и не касается реализованной базы данных. Её формулировка:
	
	\begin{lstlisting}[style=vscode-dark]
		Факториал числа n определён как произведение всех чисел от 1 до n.
		Например, факториал числа 5 равен 1*2*3*4*5=120. 
		
		Ваша задача состоит в том, чтобы написать SQL запрос, который будет использовать рекурсию для расчёта факториала заданного числа.
		
		Инициализация таблицы:
		
		CREATE TABLE factorials (
			n INT PRIMARY KEY,
			factorial BIGINT
		);
		
		INSERT INTO factorials (n, factorial)
		VALUES (0, 1),
			   (1, 1);
		
		Результат выполнения запроса будет следующим:
		n | factorial
		--+-----------
		1 |         1
		2 |         2
		3 |         6
		4 |        24
		5 |       120
	\end{lstlisting}

	Решение:
	
	\begin{lstlisting}[style=vscode-dark, language=SQL, label={code:sql}]
		WITH RECURSIVE f AS (
			WITH f_max AS (
				SELECT MAX(n) AS n
				FROM factorials
			)
			
			SELECT * FROM factorials
			
			UNION ALL
			
			SELECT f.n+1 AS n,
				f.factorial*(f.n+1) AS factorial
			FROM f, f_max
			WHERE f.n >= f_max.n AND f.n < 5
		)
		
		SELECT * FROM f
	\end{lstlisting}

	\includegraphics[scale=0.8,page=1]{query_15.png}
	
	
	\end{enumerate}
	
\end{document}